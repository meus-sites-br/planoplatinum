<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROYAL CUTS | Gestão</title>
    
    <!-- FONTS: Oswald (Títulos) & Inter (UI) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Oswald:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* =========================================
           THEME: BARBERSHOP PREMIUM (DARK & GOLD)
           ========================================= */
        :root { 
            --primary: #d4af37;       /* Dourado Clássico */
            --primary-dark: #b59024;
            --secondary: #2a2a2a;     /* Cinza Chumbo */
            
            --bg-body: #121212;       /* Preto Fundo */
            --surface: #1e1e1e;       /* Preto Cartão */
            
            --text-main: #e0e0e0;     /* Branco Suave */
            --text-muted: #888888;
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --border: #333333;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --sidebar-width: 260px;
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; }
        
        body { 
            background: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            height: 100vh; 
            overflow: hidden;
            display: flex;
        }

        h1, h2, h3, .card-title, .kpi-value, .logo-area { font-family: 'Oswald', sans-serif; letter-spacing: 1px; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOGIN SCREEN --- */
        #login-screen { 
            position: fixed; inset: 0; 
            background: #0f0f0f;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: 9999; 
            display: flex; align-items: center; justify-content: center; 
        }
        .login-card {
            background: var(--surface); width: 100%; max-width: 400px; padding: 40px;
            border-radius: 8px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border);
        }
        .login-input { 
            width: 100%; padding: 14px; background: #252525; border: 1px solid var(--border); 
            border-radius: 4px; margin-bottom: 15px; font-size: 1rem; transition: 0.3s; color: #fff;
        }
        .login-input:focus { border-color: var(--primary); }
        
        .btn-primary { 
            background: var(--primary); color: #000; border: none; padding: 14px; width: 100%;
            border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px; text-transform: uppercase;
        }
        .btn-primary:hover { background: var(--primary-dark); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: var(--surface); height: 100%;
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            transition: 0.3s; z-index: 100; position: relative;
        }
        .logo-area {
            padding: 30px; display: flex; align-items: center; gap: 10px;
            font-size: 1.5rem; color: var(--primary);
        }
        .menu-list { flex: 1; padding: 0 15px; list-style: none; overflow-y: auto; }
        .menu-item {
            display: flex; align-items: center; gap: 12px; padding: 14px 20px;
            color: var(--text-muted); border-radius: 4px; cursor: pointer; transition: 0.2s;
            margin-bottom: 5px; font-weight: 500;
        }
        .menu-item:hover, .menu-item.active { background: rgba(212, 175, 55, 0.1); color: var(--primary); border-left: 3px solid var(--primary); }
        .menu-item i { font-size: 1.2rem; }
        
        .user-profile {
            padding: 20px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px;
        }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; border: 1px solid var(--primary); }
        
        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        
        .top-bar {
            background: var(--surface); padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 90;
        }
        .page-title h2 { font-size: 1.4rem; font-weight: 400; color: var(--text-main); text-transform: uppercase; }
        .page-title p { font-size: 0.85rem; color: var(--text-muted); font-family: 'Inter', sans-serif; }
        
        .mobile-menu-btn { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main); }

        .dashboard-container { padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; }

        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card {
            background: var(--surface); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); border: 1px solid var(--border);
            position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between;
        }
        .kpi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .kpi-icon { padding: 10px; background: rgba(212, 175, 55, 0.1); border-radius: 8px; color: var(--primary); font-size: 1.5rem; }
        .kpi-value { font-size: 2.2rem; font-weight: 400; color: var(--text-main); margin-bottom: 5px; }
        .kpi-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; }
        .kpi-trend { font-size: 0.8rem; color: var(--success); display: flex; align-items: center; gap: 4px; margin-top: 10px; font-weight: 600; }

        /* CONTENT GRID */
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        /* TABLE SECTION */
        .card-section { background: var(--surface); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; margin-bottom: 30px; border: 1px solid var(--border); }
        .card-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-weight: 400; font-size: 1.1rem; text-transform: uppercase; color: var(--primary); }
        
        .search-box { padding: 15px 25px; border-bottom: 1px solid var(--border); background: #1a1a1a; }
        .search-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: #252525; color: #fff; }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { text-align: left; padding: 15px 25px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; background: #252525; font-weight: 600; }
        td { padding: 18px 25px; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #252525; }
        
        .client-cell { display: flex; align-items: center; gap: 10px; font-weight: 600; color: var(--text-main); }
        .client-avatar { width: 32px; height: 32px; background: #333; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border: 1px solid var(--border); }
        
        /* STATUS SYSTEM */
        .status-badge { padding: 5px 12px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; display: inline-block; cursor: pointer; transition: 0.2s; user-select: none; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-badge:hover { filter: brightness(1.2); }
        
        .status-badge.future { background: #1e3a8a; color: #bfdbfe; border: 1px solid #1e40af; } /* Agendado */
        .status-badge.today { background: #451a03; color: #fed7aa; border: 1px solid #9a3412; } /* Hoje */
        .status-badge.past { background: #333; color: #aaa; border: 1px solid #444; } /* Concluído */
        .status-badge.checked { background: #064e3b; color: #a7f3d0; border: 1px solid #065f46; } /* Check-in */
        .status-badge.cancel { background: #450a0a; color: #fecaca; border: 1px solid #991b1b; } /* Cancelado */
        
        .patient-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 2px; background: #333; color: #aaa; margin-left: 5px; font-weight: normal; border: 1px solid #444; text-transform: uppercase; }
        .patient-tag.vip { background: #422006; color: #fcd34d; border: 1px solid #b45309; }
        .patient-tag.new { background: #064e3b; color: #6ee7b7; border: 1px solid #059669; }

        .action-btn { 
            padding: 6px 12px; border: 1px solid var(--border); border-radius: 4px; 
            background: #252525; cursor: pointer; color: var(--text-main); font-size: 0.85rem; text-decoration: none; 
            display: inline-flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .action-btn:hover { background: var(--primary); color: #000; border-color: var(--primary); }
        
        .action-btn.checkin { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 600; }
        .action-btn.checkin:hover { background: var(--primary-dark); }

        /* LOADING OVERLAY */
        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: var(--surface); width: 90%; max-width: 600px; border-radius: 8px; padding: 25px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border); animation: modalUp 0.3s; }
        @keyframes modalUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .content-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
            .sidebar.active { left: 0; }
            .mobile-menu-btn { display: block; }
            .top-bar { padding: 15px 20px; }
            .dashboard-container { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay"><div class="spinner"></div></div>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <i class="ph ph-scissors" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
            <div style="font-family: 'Oswald'; color: #fff; font-size: 2rem; margin-bottom: 5px;">ROYAL CUTS</div>
            <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;">Acesso Administrativo</p>
            <input type="password" id="password" class="login-input" placeholder="SENHA">
            <button onclick="login()" class="btn-primary">ENTRAR</button>
            <p id="error-msg" style="color: #ef4444; font-size: 0.85rem; margin-top: 15px; display: none;">Senha incorreta.</p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-area"><i class="ph ph-scissors" style="color:var(--primary); margin-right: 10px;"></i> ROYAL CUTS</div>
        <ul class="menu-list">
            <li class="menu-item active" onclick="switchView('dashboard')"><i class="ph ph-squares-four"></i> Dashboard</li>
            <li class="menu-item" onclick="switchView('reception')"><i class="ph ph-list-checks"></i> Recepção</li>
            <li class="menu-item" onclick="switchView('appointments')"><i class="ph ph-calendar"></i> Agenda</li>
            <li class="menu-item" onclick="switchView('patients')"><i class="ph ph-users"></i> Clientes</li>
            <li class="menu-item" onclick="switchView('finance')"><i class="ph ph-currency-circle-dollar"></i> Caixa</li>
            <li class="menu-item" onclick="switchView('settings')"><i class="ph ph-gear"></i> Config</li>
        </ul>
        <div class="user-profile">
            <div class="avatar">AD</div>
            <div style="flex: 1;">
                <div style="font-size: 0.9rem; font-weight: 600; color: #fff;">Admin</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Gerente</div>
            </div>
            <i class="ph ph-sign-out" style="cursor: pointer; color: #ef4444;" onclick="logout()"></i>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="ph ph-list"></i></div>
                <div class="page-title">
                    <h2 id="page-header-title">Visão Geral</h2>
                    <p id="current-date">...</p>
                </div>
            </div>
            <button onclick="fetchData()" class="action-btn">
                <i class="ph ph-arrows-clockwise"></i> <span style="display:none; @media(min-width:600px){display:inline;}">Atualizar</span>
            </button>
        </div>

        <div class="dashboard-container">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="fade-in">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon"><i class="ph ph-calendar-check"></i></div></div>
                        <div class="kpi-value" id="kpi-total">0</div>
                        <div class="kpi-label">Cortes Agendados</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon" style="color: var(--success); background: rgba(16, 185, 129, 0.1);"><i class="ph ph-currency-dollar"></i></div></div>
                        <div class="kpi-value" id="kpi-revenue">R$ 0</div>
                        <div class="kpi-label">Faturamento Est.</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon" style="color: var(--primary); background: rgba(212, 175, 55, 0.1);"><i class="ph ph-clock-countdown"></i></div></div>
                        <div class="kpi-value" id="kpi-next-time" style="font-size: 1.8rem;">--:--</div>
                        <div class="kpi-label">Próximo Cliente</div>
                        <div class="kpi-trend" id="kpi-next-date">Sem agenda</div>
                    </div>
                </div>

                <div class="content-grid">
                    <div class="card-section">
                        <div class="card-header">
                            <div class="card-title">Próximos Cortes</div>
                            <button class="action-btn" onclick="switchView('appointments')">Ver Todos</button>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Cliente</th><th>Serviço</th><th>Horário</th><th>Status</th></tr></thead>
                                <tbody id="table-dashboard"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="card-header"><div class="card-title">Serviços Populares</div></div>
                        <div style="padding: 20px;">
                            <canvas id="chartDashboard" style="height: 200px; width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RECEPTION -->
            <div id="view-reception" class="hidden fade-in">
                <div class="card-section">
                    <div class="card-header">
                        <div class="card-title">Fila de Atendimento</div>
                        <div style="font-size: 0.8rem; color: var(--primary);">HOJE</div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Horário</th><th>Cliente</th><th>Serviço</th><th>Status</th><th>Ação</th></tr></thead>
                            <tbody id="table-reception"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- APPOINTMENTS -->
            <div id="view-appointments" class="hidden fade-in">
                <div class="card-section">
                    <div class="card-header"><div class="card-title">Agenda Completa</div></div>
                    <div class="search-box">
                        <input type="text" id="search-appointments" class="search-input" placeholder="Buscar cliente..." onkeyup="filterTable('appointments')">
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Cliente</th><th>Serviço</th><th>Data & Hora</th><th>Status (Alterar)</th><th>Whats</th></tr></thead>
                            <tbody id="table-appointments"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CLIENTS -->
            <div id="view-patients" class="hidden fade-in">
                <div class="card-section">
                    <div class="card-header">
                        <div class="card-title">Base de Clientes</div>
                    </div>
                    <div class="search-box">
                        <input type="text" id="search-patients" class="search-input" placeholder="Buscar por nome ou telefone..." onkeyup="filterTable('patients')">
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Cliente</th><th>Perfil</th><th>Última Visita</th><th>Histórico</th></tr></thead>
                            <tbody id="table-patients"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FINANCE -->
            <div id="view-finance" class="hidden fade-in">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Faturamento Total</div>
                        <div class="kpi-value" id="fin-total" style="color: var(--success);">R$ 0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ticket Médio</div>
                        <div class="kpi-value" id="fin-ticket" style="color: var(--primary);">R$ 0</div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="card-section">
                        <div class="card-header"><div class="card-title">Receita por Serviço</div></div>
                        <div style="padding: 20px; height: 300px;">
                            <canvas id="chartServices"></canvas>
                        </div>
                    </div>
                    <div class="card-section">
                        <div class="card-header"><div class="card-title">Resumo Mensal</div></div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Mês</th><th>Receita</th></tr></thead>
                                <tbody id="table-finance-months"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="view-settings" class="hidden fade-in">
                <div class="card-section" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-header"><div class="card-title">Segurança</div></div>
                    <div style="padding: 30px;">
                        <p style="margin-bottom: 20px; color: var(--text-muted);">Alterar senha de acesso (Salvo localmente)</p>
                        <input type="password" id="new-pass" class="login-input" placeholder="Nova Senha">
                        <input type="password" id="confirm-pass" class="login-input" placeholder="Confirmar Senha">
                        <button class="btn-primary" onclick="changePassword()">Salvar</button>
                        <p id="msg-settings" style="margin-top:15px; font-weight:600; font-size:0.9rem;"></p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- CLIENT MODAL -->
    <div class="modal-overlay" id="patientModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                <h3 style="font-family:'Oswald'; color:var(--primary); font-size:1.5rem;" id="modal-title">Histórico</h3>
                <i class="ph ph-x" style="font-size:1.5rem; cursor:pointer; color:var(--text-muted);" onclick="closeModal()"></i>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = "https://script.google.com/macros/s/AKfycbwn_HH6DEGS7eBlSyt2m7qw2lBUvm5tEP-qKiwvt12DHkG6vCSZ_MvdY3s6YUXYev4irQ/exec";
        const NEXUS_TOKEN = "NEXUS_BKR_ROYAL_2025_SECURE";
        let globalData = [];
        let charts = {};

        // INIT
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });

        // LOGIN
        function login() {
            const pass = document.getElementById('password').value;
            const storedPass = localStorage.getItem('nexus_barber_pass') || "admin123";
            if(pass === storedPass) {
                document.getElementById('login-screen').style.display='none';
                fetchData();
            } else {
                document.getElementById('error-msg').style.display = "block";
            }
        }
        function logout() {
            document.getElementById('login-screen').style.display='flex';
            document.getElementById('password').value = '';
        }
        function changePassword() {
            const p1 = document.getElementById('new-pass').value;
            const p2 = document.getElementById('confirm-pass').value;
            const msg = document.getElementById('msg-settings');
            if(p1 && p1 === p2) {
                localStorage.setItem('nexus_barber_pass', p1);
                msg.style.color = "var(--success)"; msg.innerText = "Senha alterada!";
                document.getElementById('new-pass').value = ''; document.getElementById('confirm-pass').value = '';
            } else { msg.style.color = "var(--danger)"; msg.innerText = "Erro nas senhas."; }
        }

        // VIEW LOGIC
        function switchView(viewName) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active'); 
            ['dashboard', 'reception', 'appointments', 'patients', 'finance', 'settings'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('active');
            
            if(viewName === 'patients') renderPatients();
            if(viewName === 'reception') renderReception();
            if(viewName === 'finance') renderFinance();
            
            const titles = { 'dashboard': 'Visão Geral', 'reception': 'Recepção', 'appointments': 'Agenda', 'patients': 'Base de Clientes', 'finance': 'Financeiro', 'settings': 'Configurações' };
            document.getElementById('page-header-title').innerText = titles[viewName];
        }

        // FETCH DATA
        async function fetchData() {
            try {
                const res = await fetch(`${API_URL}?token=${NEXUS_TOKEN}&t=${new Date().getTime()}`);
                const json = await res.json();
                
                // Mapeamento correto com o status vindo da planilha (coluna 6, indice 5) se existir
                globalData = (json.agendamentos || []).reverse().map((r, idx) => {
                    // Logic Price Barber
                    let price = 50; // Base
                    const s = (r[3] || "").toLowerCase();
                    if(s.includes('corte') && s.includes('barba')) price = 90;
                    else if(s.includes('corte')) price = 60;
                    else if(s.includes('barba')) price = 40;
                    else if(s.includes('pigmentação')) price = 80;

                    const dateRaw = r[1] || "";
                    const timeRaw = r[2] || "";
                    const telRaw = r[4] || "";
                    
                    // Supõe que o status está na coluna F (indice 5)
                    const sheetStatus = r[5] || ""; 
                    
                    let finalStatus = { label: 'Agendado', class: 'future' };
                    if(sheetStatus) {
                        if(sheetStatus === 'Na Cadeira') finalStatus = { label: 'Na Cadeira', class: 'checked' }; // Termo de barbearia
                        else if(sheetStatus === 'Concluído') finalStatus = { label: 'Concluído', class: 'past' };
                        else if(sheetStatus === 'Cancelado') finalStatus = { label: 'Cancelado', class: 'cancel' };
                        else if(sheetStatus === 'Confirmado') finalStatus = { label: 'Confirmado', class: 'checked' };
                    } else {
                        finalStatus = getStatus(dateRaw, timeRaw);
                    }

                    return {
                        id: `${String(r[4]).replace(/\D/g,'')}-${dateRaw}-${timeRaw}`.replace(/\s/g,''),
                        // Guardamos o indice original para atualização (row = index + 2 pois tem header e é 1-based)
                        rowIndex: json.agendamentos.length - idx + 1, 
                        hora: timeRaw,
                        nome: String(r[0] || "Cliente").replace(/'/g,''),
                        data: String(dateRaw).replace(/'/g,''),
                        servico: r[3] || "Corte",
                        tel: String(r[4] || "").replace(/\D/g,''), // Para links whats
                        telRaw: String(r[4] || ""), // Para devolver pro backend achar a linha
                        price: price,
                        status: finalStatus,
                        rawDate: parseDateSafe(dateRaw)
                    };
                });
                renderDashboard();
                renderAppointments(); 
            } catch(e) { console.error(e); alert("Erro ao carregar dados."); }
        }

        async function updateSheetStatus(item, newStatusLabel) {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // CORREÇÃO CRÍTICA: Enviar JSON como text/plain para evitar Preflight CORS e incluir linha/dados originais
            const payload = {
                token: NEXUS_TOKEN,
                action: "updateStatus",
                data: item.data,
                hora: item.hora,
                telefone: item.telRaw, // Envia o original
                telefoneClean: item.tel, // Envia o limpo por via das duvidas
                row: item.rowIndex, // Envia a linha exata
                novoStatus: newStatusLabel
            };

            console.log("Enviando Payload:", payload); // Debug no console

            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Header correto para GAS
                    body: JSON.stringify(payload) 
                });

                // Simular sucesso visual após 1.5s (já que no-cors não retorna sucesso real)
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    renderAppointments(); renderReception(); renderDashboard();
                }, 1500);
            } catch (error) { 
                document.getElementById('loading-overlay').style.display = 'none'; 
                console.error(error);
                alert("Erro de conexão."); 
            }
        }

        // HELPERS
        function getStatus(dateStr, timeStr) {
            if(!dateStr) return { label: 'Pendente', class: 'future' };
            try {
                const parts = dateStr.split('/');
                if(parts.length < 2) return { label: 'Agendado', class: 'future' };
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; 
                const year = new Date().getFullYear();
                const d = new Date(year, month, day);
                const now = new Date();
                
                if (d < now && d.getDate() != now.getDate()) return { label: 'Concluído', class: 'past' };
                if (d.getDate() == now.getDate() && d.getMonth() == now.getMonth()) return { label: 'Hoje', class: 'today' };
                return { label: 'Agendado', class: 'future' };
            } catch(e) { return { label: 'Agendado', class: 'future' }; }
        }

        // --- CORREÇÃO DE DATA ---
        function parseDateSafe(dateStr) {
            if(!dateStr) return new Date();
            
            // Tenta formato ISO YYYY-MM-DD (comum em APIs Google)
            if(dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if(parts.length === 3) return new Date(parts[0], parts[1]-1, parts[2]);
            }

            // Tenta formato DD/MM/YYYY
            const parts = dateStr.split('/');
            if(parts.length >= 2) return new Date(new Date().getFullYear(), parseInt(parts[1]) - 1, parseInt(parts[0]));
            
            return new Date(); // Fallback
        }

        function cycleStatus(id) {
            const item = globalData.find(i => i.id === id);
            if(!item) return;
            const states = [ { label: 'Agendado', class: 'future' }, { label: 'Confirmado', class: 'checked' }, { label: 'Na Cadeira', class: 'today' }, { label: 'Concluído', class: 'past' }, { label: 'Cancelado', class: 'cancel' } ];
            let idx = (states.findIndex(s => s.label === item.status.label) + 1) % states.length;
            item.status = states[idx];
            updateSheetStatus(item, item.status.label);
        }

        function doCheckIn(id) {
            const item = globalData.find(i => i.id === id);
            if(item) { item.status = { label: 'Na Cadeira', class: 'checked' }; updateSheetStatus(item, 'Na Cadeira'); }
        }

        function openPatientHistory(phone) {
            const history = globalData.filter(i => i.tel === phone);
            document.getElementById('modal-title').innerText = history[0]?.nome || "Cliente";
            const body = document.getElementById('modal-body');
            body.innerHTML = '';
            history.forEach(h => {
                body.innerHTML += `<div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <div><div style="font-weight:600; color:var(--text-main);">${h.servico}</div><div style="font-size:0.85rem; color:var(--text-muted);">${h.data} às ${h.hora}</div></div>
                    <span class="status-badge ${h.status.class}">${h.status.label}</span></div>`;
            });
            document.getElementById('patientModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('patientModal').style.display = 'none'; }

        // RENDERS
        function renderDashboard() {
            const tbody = document.getElementById('table-dashboard'); tbody.innerHTML = '';
            let totalRev = 0;
            
            // --- CORREÇÃO: Lógica do "Próximo Horário" ---
            const upcoming = globalData.filter(i => i.status.class === 'future' || i.status.class === 'today');
            upcoming.sort((a, b) => {
                const diff = a.rawDate - b.rawDate;
                if(diff !== 0) return diff;
                return a.hora.localeCompare(b.hora);
            });
            const nextSession = upcoming.length > 0 ? upcoming[0] : null;
            // ---------------------------------------------

            globalData.forEach((item, idx) => {
                if(item.status.label !== 'Cancelado') totalRev += item.price;
                if(idx < 5) tbody.innerHTML += `<tr><td><div class="client-cell"><div class="client-avatar">${item.nome.charAt(0)}</div>${item.nome}</div></td><td>${item.servico}</td><td>${item.hora}</td><td><span class="status-badge ${item.status.class}">${item.status.label}</span></td></tr>`;
            });
            document.getElementById('kpi-total').innerText = globalData.length;
            document.getElementById('kpi-revenue').innerText = `R$ ${totalRev.toLocaleString('pt-BR')}`;
            
            if(nextSession) {
                document.getElementById('kpi-next-time').innerText = nextSession.hora;
                document.getElementById('kpi-next-date').innerText = `${nextSession.data} - ${nextSession.nome.split(' ')[0]}`;
            } else {
                document.getElementById('kpi-next-time').innerText = "--:--";
                document.getElementById('kpi-next-date').innerText = "Sem agenda";
            }

            renderChart('chartDashboard', 'doughnut', {
                labels: ['Corte', 'Barba', 'Combo'],
                datasets: [{
                    data: [
                        globalData.filter(i => i.servico.toLowerCase().includes('corte') && !i.servico.toLowerCase().includes('barba')).length,
                        globalData.filter(i => i.servico.toLowerCase().includes('barba') && !i.servico.toLowerCase().includes('corte')).length,
                        globalData.filter(i => i.servico.toLowerCase().includes('corte') && i.servico.toLowerCase().includes('barba')).length
                    ],
                    backgroundColor: ['#d4af37', '#e0e0e0', '#2a2a2a'],
                    borderColor: '#1e1e1e'
                }]
            });
        }

        function renderAppointments() {
            const tbody = document.getElementById('table-appointments'); tbody.innerHTML = '';
            globalData.forEach(item => {
                tbody.innerHTML += `<tr><td><div class="client-cell"><div class="client-avatar">${item.nome.charAt(0)}</div><div>${item.nome}</div></div></td><td>${item.servico}</td><td>${item.data} <small style="color:var(--primary);">${item.hora}</small></td><td><span class="status-badge ${item.status.class}" onclick="cycleStatus('${item.id}')">${item.status.label}</span></td><td><a href="https://wa.me/55${item.tel}" target="_blank" class="action-btn"><i class="ph ph-whatsapp-logo" style="color:#25d366;"></i></a></td></tr>`;
            });
        }

        function renderReception() {
            const tbody = document.getElementById('table-reception'); tbody.innerHTML = '';
            const todayStr = new Date().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            const list = globalData.filter(item => (item.data.includes(todayStr.split('/')[0]+'/'+todayStr.split('/')[1]) || item.status.label === 'Na Cadeira') && item.status.label !== 'Cancelado');
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted)">Agenda vazia hoje.</td></tr>'; return; }
            list.forEach(item => {
                tbody.innerHTML += `<tr><td style="font-weight:bold; font-size:1.1rem; color:var(--primary);">${item.hora}</td><td><div class="client-cell"><div class="client-avatar">${item.nome.charAt(0)}</div>${item.nome}</div></td><td>${item.servico}</td><td><span class="status-badge ${item.status.class}">${item.status.label}</span></td><td>${item.status.label !== 'Na Cadeira' && item.status.label !== 'Concluído' ? `<button class="action-btn checkin" onclick="doCheckIn('${item.id}')">CHECK-IN</button>` : '<i class="ph ph-check" style="color:var(--success)"></i>'}</td></tr>`;
            });
        }

        function renderPatients() {
            const tbody = document.getElementById('table-patients'); tbody.innerHTML = '';
            const patients = {};
            globalData.forEach(item => {
                const key = item.tel && item.tel.length > 8 ? item.tel : item.nome;
                if(!patients[key]) patients[key] = { name: item.nome, count: 0, last: item.rawDate, tel: item.tel };
                patients[key].count++;
                if(item.rawDate > patients[key].last) { patients[key].last = item.rawDate; patients[key].name = item.nome; }
            });
            Object.values(patients).forEach(data => {
                const dateStr = data.last.toLocaleDateString('pt-BR') !== 'Invalid Date' ? data.last.toLocaleDateString('pt-BR') : '-';
                let tag = '<span class="patient-tag new">Novo</span>';
                if(data.count > 5) tag = '<span class="patient-tag vip">VIP</span>'; else if(data.count > 1) tag = '<span class="patient-tag">Fiel</span>';
                tbody.innerHTML += `<tr><td><div class="client-cell"><div class="client-avatar">${data.name.charAt(0)}</div><div>${data.name} <br><small style="color:var(--text-muted)">${data.tel}</small></div></div></td><td>${tag}</td><td>${dateStr}</td><td><button onclick="openPatientHistory('${data.tel}')" class="action-btn"><i class="ph ph-list-dashes"></i></button></td></tr>`;
            });
        }

        function renderFinance() {
            const totalRev = globalData.reduce((acc, curr) => (curr.status.label !== 'Cancelado' ? acc + curr.price : acc), 0);
            document.getElementById('fin-total').innerText = `R$ ${totalRev.toLocaleString('pt-BR')}`;
            document.getElementById('fin-ticket').innerText = `R$ ${(totalRev / (globalData.length || 1)).toFixed(2)}`;
            const services = {}; globalData.forEach(i => { if(i.status.label !== 'Cancelado') services[i.servico] = (services[i.servico] || 0) + i.price; });
            renderChart('chartServices', 'bar', { labels: Object.keys(services), datasets: [{ label: 'Receita', data: Object.values(services), backgroundColor: '#d4af37', borderRadius: 2 }] });
            const months = {}; globalData.forEach(i => { if(i.status.label !== 'Cancelado') { const m = i.rawDate.toLocaleString('default', { month: 'short' }); months[m] = (months[m] || 0) + i.price; }});
            const tbody = document.getElementById('table-finance-months'); tbody.innerHTML = '';
            Object.entries(months).forEach(([m, val]) => tbody.innerHTML += `<tr><td style="text-transform:uppercase;">${m}</td><td style="color:var(--primary);">R$ ${val.toLocaleString('pt-BR')}</td></tr>`);
        }

        function renderChart(id, type, data) {
            if(charts[id]) charts[id].destroy();
            Chart.defaults.color = '#888'; Chart.defaults.borderColor = '#333';
            charts[id] = new Chart(document.getElementById(id).getContext('2d'), { type: type, data: data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }

        function filterTable(view) {
            const input = document.getElementById(`search-${view}`).value.toLowerCase();
            const rows = document.getElementById(`table-${view}`).getElementsByTagName('tr');
            for(let i=0; i<rows.length; i++) rows[i].style.display = rows[i].textContent.toLowerCase().includes(input) ? '' : 'none';
        }
    </script>
</body>
</html>